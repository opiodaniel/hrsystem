{% extends "base_employee_dashboard.html" %}
{% load static %}

{% block title %}
  Distributor
{% endblock %}


{% block content %}

  <!-- Toast Notification Container (for custom JS toasts) -->
        <div id="toast-container" aria-live="polite" aria-atomic="true">
            <!-- Toasts will be appended here by the showToast function -->
        </div>

  <div class="row g-6">
          <!-- Card Border Shadow -->
        <div class="col-lg-3 col-sm-6">
            <div class="card card-border-shadow-danger h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <div class="avatar me-4">
                    <span class="avatar-initial rounded bg-label-danger"><i class="fa fa-users text-warning" aria-hidden="true" style='font-size:50px;'></i></span>
                  </div>
                  <h4 class="mb-0">{{ total_employees }}</h4>
                </div>
                <p class="mb-2">Distributors</p>
                <p class="mb-0">
                  <span class="text-heading fw-medium me-2">5</span>
                  <span class="text-muted">Distributors Added (This Month)</span>
                </p>
              </div>
            </div>
        </div>

          <div class="col-lg-3 col-sm-6">
            <div class="card card-border-shadow-primary h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <div class="avatar me-4">
                    <span class="avatar-initial rounded bg-label-info"><i class="fa fa-users " aria-hidden="true" style='font-size:40px;color:blue'></i></span>
                  </div>
                  <h4 class="mb-0">{{kpi_total_clients}}</h4>
                </div>
                <p class="mb-2">My Clients</p>
                <p class="mb-0">
                  <span class="text-heading fw-medium me-2">{{ kpi_clients_month|default:0 }}</span>
                  <span class="text-muted">Clients Added (This Month)</span>
                </p>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-sm-6">
            <div class="card card-border-shadow-success h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <div class="avatar me-4">
                    <span class="avatar-initial rounded bg-label-success"><i class="fa fa-chart-line fa-3x text-success"></i></span>
                  </div>
                  <h4 class="mb-0">{{ kpi_top_distributor|default:"N/A"|safe }}</h4>
                </div>
                <p class="mb-2">Top Generator</p>
                <p class="mb-0">
                  <span class="text-heading fw-medium me-2">{{ kpi_top_distributor_count }}</span>
                  <span class="text-muted">Clients Added (This Month)</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-sm-6">
            <div class="card card-border-shadow-info h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <div class="avatar me-4">
                    <span class="avatar-initial rounded bg-label-info"><i class="fa fa-chart-bar fa-3x text-info" aria-hidden="true"></i></span>
                  </div>
                  <h4 class="mb-0">{{ total_paid }}</h4>
                </div>
                <p class="mb-2">Total Amount Paid</p>
                <p class="mb-0">
                  <!--
                  <span class="text-heading fw-medium me-2">-8.7%</span>
                  <span class="text-muted">than last week</span>
                  -->
                </p>
              </div>
            </div>
          </div>
          <!--/ Card Border Shadow -->

         <!-- Shipment statistics-->
          <div class="col-xxl-4 col-lg-5">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between">
              </div>
              <div class="">
                <!-- Main Leaderboard Card Container -->
                <div class="container">
                    <div class="card shadow-lg mx-auto" style="max-width: 500px;">
                        <!-- Header -->
                        <div class="card-header bg-primary text-white text-center py-4 rounded-top">
                            <h1 class="h3 fw-bold mb-0">Top Distributors</h1>
                            <p class="mb-0 text-white-50">Clients Logged This Month</p>
                        </div>

                        <!-- Leaderboard List (List Group) -->
                        <ul class="list-group list-group-flush">
                            {% for leader in leaderboard_list %}
                            <!-- RANK 1: GOLD WINNER -->
                                <li class="list-group-item
                                    {% if forloop.counter == 1 %}rank-gold{% elif forloop.counter == 2 %}rank-silver{% elif forloop.counter == 3 %}rank-bronze{% endif %}
                                    d-flex justify-content-between align-items-center border-0
                                    {% if forloop.counter < 3 %}border-bottom{% endif %}">

                                    <div class="d-flex align-items-center">
                                        <span class="me-3">

                                            <!-- CONDITIONAL ICON/RANK DISPLAY -->
                                            {% if forloop.counter == 1 %}
                                                <span class="p-1 rounded-circle text-warning-emphasis">
                                                    <svg class="crown-icon text-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M5 15S4 12 7 12s3 2 4 2s3-2 4-2s3 2 4 2V3h-3l-1 5-2-5-2 5-2-5-1 5H5z"/>
                                                    </svg>
                                                </span>
                                            {% else %}
                                                <!-- Display numerical rank for 2 and 3 -->
                                                <span class="h5 fw-bold text-muted" style="min-width: 1.5rem; text-align: center;">{{ forloop.counter }}</span>
                                            {% endif %}
                                        </span>

                                        <div class="name-text fw-bolder">{{ leader.name }}</div>
                                    </div>
                                    <!-- Client Count -->
                                    <div class="d-flex align-items-center">
                                        <span class="count-text fw-bolder text-primary me-2">{{ leader.count }}</span>
                                        <span class="badge bg-secondary-subtle text-secondary d-none d-sm-inline">Clients</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

              </div>
            </div>
          </div>
          <!--/ Shipment statistics -->

          <!-- Vehicles overview -->
          <div class="col-xxl-8">
            <div class="card h-80">
              <div class="card-header d-flex align-items-center justify-content-between">
                <div class="card-title mb-0">
                  <h5 class="m-0 me-2">Approved/pending Clients</h5>
                </div>
              </div>
              <div class="card-body">
                  <canvas  id="transaction-history" class="transaction-chart" ></canvas>
              </div>
            </div>
          </div>
          <!--/ Vehicles overview -->


          <div class="container-fluid py-4">
            <div class="row g-4">
                <!-- Left Column: New Client Entry Form (col-lg-4 equivalent to lg:col-span-1) -->
                <div class="col-12 col-lg-4">
                    <div class="card shadow-lg border-0 form-card h-100">
                        <div class="card-body p-4">
                            <h2 class="card-title h4 fw-bold text-dark mb-4 border-bottom pb-2">Log New Client Lead</h2>
                            <form id="new-client-form" class="needs-validation" novalidate>

                                <!-- Client Full Name -->
                                <div class="mb-3">
                                    <label for="client_name" class="form-label text-muted fw-medium">Client Full Name <span class="text-danger">*</span></label>
                                    <input type="text" id="client_name" name="client_name" required class="form-control" placeholder="John Doe">
                                    <div class="invalid-feedback">Client name is required.</div>
                                </div>

                                <!-- Contact 1 -->
                                <div class="mb-3">
                                    <label for="contact_1" class="form-label text-muted fw-medium">Contact 1 (Primary) <span class="text-danger">*</span></label>
                                    <input type="text" id="contact_1" name="contact_1" required class="form-control" placeholder="e.g., +1 555 123 4567 or email@example.com">
                                    <div class="invalid-feedback">Primary contact is required.</div>
                                </div>

                                <!-- Contact 2 -->
                                <div class="mb-3">
                                    <label for="contact_2" class="form-label text-muted fw-medium">Contact 2 (Optional)</label>
                                    <input type="text" id="contact_2" name="contact_2" class="form-control" placeholder="Alternative Phone or Email">
                                </div>

                                <!-- Initial Notes -->
                                <div class="mb-4">
                                    <label for="initial_notes" class="form-label text-muted fw-medium">Initial Notes</label>
                                    <textarea id="initial_notes" name="initial_notes" rows="3" class="form-control" placeholder="Key points from the conversation, status, etc."></textarea>
                                </div>

                                <button type="submit" id="client-submit-btn" class="btn btn-info btn-lg w-100 fw-semibold shadow-sm d-flex align-items-center justify-content-center">
                                    <!-- SVG Icon (using Font Awesome class for cleaner Bootstrap look or inline SVG) -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                                    <span>Submit New Client</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                        <!-- Right Column: My Clients List -->
                <div class="col-12 col-lg-8">
                    <div class="card shadow-lg border-0">
                        <div class="card-body p-4">

                            <div class="card-header bg-primary text-white py-3">
                                <h2 class="h5 mb-0 d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-people-fill me-2" viewBox="0 0 16 16">
                                      <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm-4 1s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1z"/>
                                      <path fill-rule="evenodd" d="M12 2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2zm-2 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0m2-6a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                                    </svg>
                                    My Clients
                                    <span class="badge bg-secondary ms-2 rounded-pill">{{ kpi_total_clients|default:0 }} Total</span>
                                </h2>
                            </div>

                            <!-- Client List Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="text-uppercase text-secondary fs-6 fw-medium">Client Name</th>
                                            <th scope="col" class="text-uppercase text-secondary fs-6 fw-medium">Contact 1</th>
                                            <th scope="col" class="text-center text-uppercase text-secondary fs-6 fw-medium">Date Logged</th>
                                            <th scope="col" class="text-center text-uppercase text-secondary fs-6 fw-medium">Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="client-list-body">
                                        <!-- DATA IS POPULATED VIA SERVER-SIDE TEMPLATING HERE -->
                                        {% if clients %}
                                            {% for client in clients %}
                                                <tr>
                                                    <td class="text-nowrap">{{ client.fullName }}</td>
                                                    <td class="text-nowrap">{{ client.contact1 }}</td>
                                                    <td class="text-center text-nowrap">{{ client.dateLogged|default:"N/A" }}</td>
                                                    <td class="text-center">
                                                        <button class="btn btn-sm btn-info">Edit</button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">
                                                    You have no client leads yet. Use the form on the left!
                                                </td>
                                            </tr>
                                        {% endif %}
                                        <!-- END SERVER-SIDE POPULATION -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>

        <!-- Reusable Bootstrap Modal -->
        <div class="modal fade" id="detail-modal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">Client Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Modal content goes here -->
                        <p>This is a reusable modal using the standard Bootstrap component.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>




  </div>
{% endblock %}

{% block add_js %}
    <script>
    // NOTE: This assumes 'Cookies' and 'csrftoken' are available globally, as per your original script.
    // Since we don't have the context for those, I've left the AJAX setup as-is, assuming they work in your environment.

    // --- Modal Control Functions (Adapted to use Bootstrap 5 JS API) ---
    const detailModal = new bootstrap.Modal(document.getElementById('detail-modal'), {});

    function openModal(id) {
        // Since we only have one modal (#detail-modal) configured, we can trigger it directly
        if (id === 'detail-modal') {
             detailModal.show();
        }
    }

    function closeModal(id) {
        if (id === 'detail-modal') {
             detailModal.hide();
        }
    }

    // --- Toast Notification System (Redesigned with custom Bootstrap-friendly styling) ---
    function showToast(message, type = 'success') {
        const container = $('#toast-container');
        let colorClass = '';
        let iconPath = '';

        if (type === 'success') {
            colorClass = 'bg-success';
            iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        } else if (type === 'error') {
            colorClass = 'bg-danger';
            iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        } else {
             colorClass = 'bg-info';
             iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        }

        const toast = $(`
            <div class="p-3 rounded custom-toast text-white d-flex align-items-center mb-2 shadow ${colorClass}" role="alert" aria-live="assertive" aria-atomic="true">
                <svg class="flex-shrink-0 me-2" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    ${iconPath}
                </svg>
                <div class="me-auto fw-medium">${message}</div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);

        container.append(toast);

        // Animate in using custom class and slight delay
        setTimeout(() => toast.addClass('show-toast'), 10);

        // Animate out and remove after 5 seconds
        setTimeout(() => {
            toast.removeClass('show-toast');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // --- Placeholder for CSRF/Auth (needed for your AJAX call) ---
    var csrftoken = Cookies.get('csrftoken'); // Replace with actual logic if needed

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
        }
    });

    $(document).ready(function() {
        // Conceptual URL for the server-side view (assuming Django/Flask route)
        const SUBMIT_URL = '/api/submit_client_lead/';

        // --- 1. Client Submission Form Handling (AJAX) ---
        $('#new-client-form').on('submit', function(e) {
            e.preventDefault();

            const form = $(this);
            const submitBtn = $('#client-submit-btn');
            const originalText = submitBtn.html();

            // 1. Collect and Validate Data
            const clientName = $('#client_name').val().trim();
            const contact1 = $('#contact_1').val().trim();
            const contact2 = $('#contact_2').val().trim();
            const initialNotes = $('#initial_notes').val().trim();

            let isValid = true;

            // Simple validation check
            if (clientName.length < 3) {
                 $('#client_name').addClass('is-invalid');
                 isValid = false;
            } else {
                 $('#client_name').removeClass('is-invalid').addClass('is-valid');
            }

            if (contact1.length < 5) { // Basic length check for phone or email
                 $('#contact_1').addClass('is-invalid');
                 isValid = false;
            } else {
                 $('#contact_1').removeClass('is-invalid').addClass('is-valid');
            }

            if (!isValid) {
                 showToast("Please correct the required fields.", 'error');
                 return;
            }

            // 2. Prepare JSON Payload
            const payload = {
                fullName: clientName,
                contact1: contact1,
                contact2: contact2 || null, // Send null if contact2 is empty
                initialNotes: initialNotes
            };

            // 3. Update UI for Submission (Bootstrap spinner)
            submitBtn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Submitting...');
            submitBtn.prop('disabled', true);

            // 4. Actual AJAX Call (Uncomment and remove mock above when deployed)
            $.ajax({
                url: SUBMIT_URL,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    showToast(`Client ${clientName} logged successfully! ID: ${response.id}`, 'success');
                    form.trigger('reset');
                    $('.form-control').removeClass('is-valid is-invalid');
                },
                error: function(xhr) {
                    let errorMessage = "An unknown error occurred.";
                    try {
                        const errorJson = JSON.parse(xhr.responseText);
                        errorMessage = errorJson.error || errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Error ${xhr.status}: ${xhr.statusText}`;
                    }
                    showToast(`Submission failed: ${errorMessage}`, 'error');
                },
                complete: function() {
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                }
            });
        });
    });
</script>

{% endblock %}




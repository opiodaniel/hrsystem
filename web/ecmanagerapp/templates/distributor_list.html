{% extends 'admin_base.html' %}
{% load static %}

    {% block content %}

        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current Employee List</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="employee-list-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email/Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Dummy Data Rows (Add data-uid for deletion) -->
                        <!-- In a real app, this would be populated dynamically by Django/JS -->
                         {% for emp in employees %}
                        <tr data-uid="{{ emp.uid }}" data-name="{{ emp.email }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ emp.full_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ emp.email }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ emp.last_login }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button class="delete-btn text-red-600 hover:text-red-900 font-semibold text-xs py-1 px-3 rounded-full hover:bg-red-50 transition duration-150">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>


        <!-- EMPLOYEE DELETION CONFIRMATION MODAL -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4 transition-opacity duration-300"
             onclick="toggleConfirmationModal(false)">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm"
                 onclick="event.stopPropagation()">

                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i> Confirm Deletion
                </h2>
                <p class="text-gray-600 mb-6">Are you sure you want to permanently delete employee <span id="employee-name-to-delete" class="font-bold text-red-600"></span>? This action cannot be undone.</p>

                <div class="flex justify-end space-x-3">
                    <button onclick="toggleConfirmationModal(false)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button onclick="deleteEmployee()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150" id="confirm-delete-btn">
                        Yes, Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATION CONTAINER (Global Message Area) -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 w-full max-w-xs pointer-events-none">
            <!-- Toasts will be dynamically inserted here -->
        </div>

    {% endblock content %}

    {% block script %}

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>

        // ---- CSRF setup ----
          var csrftoken = Cookies.get('csrftoken');

          function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
          }

          $.ajaxSetup({
            beforeSend: function(xhr, settings) {
              if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
            }
          });

        // Global variable to hold the UID of the employee pending deletion
        let employeeToDeleteUID = null;
        let employeeToDeleteName = null;

        // --- Dashboard & Modal Toggling Logic ---


        // 3. Delete Confirmation Modal Toggle
        function toggleConfirmationModal(show) {
            const modal = document.getElementById('confirmation-modal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                employeeToDeleteUID = null; // Clear UID on close
                employeeToDeleteName = null;
            }
        }

        // 5. Toast Notification System
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const color = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

            const toast = document.createElement('div');
            toast.className = `${color} text-white px-4 py-3 rounded-lg shadow-xl mb-3 flex items-center transform transition-all duration-300 ease-out translate-x-full opacity-0 pointer-events-auto`;
            toast.innerHTML = `
                <i class="fas ${icon} mr-3"></i>
                <span>${message}</span>
            `;

            toastContainer.prepend(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');

                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode === toastContainer) {
                        toastContainer.removeChild(toast);
                    }
                }, { once: true });

            }, 5000);
        }

        // --- AJAX Deletion Logic ---

        function deleteEmployee() {
            if (!employeeToDeleteUID) {
                showToast("Error: No employee selected for deletion.", 'error');
                toggleConfirmationModal(false);
                return;
            }

            const deleteButton = $('#confirm-delete-btn');
            const employeeRow = $(`tr[data-uid="${employeeToDeleteUID}"]`);

            // Disable button and show loading state
            deleteButton.prop('disabled', true).text('Deleting...').removeClass('bg-red-600').addClass('bg-gray-500 opacity-70');

            // Assume the deletion endpoint is '/delete-employee/'
            const url = '/delete-employee/';

            $.ajax({
                url: url,
                type: 'POST',
                data: { uid: employeeToDeleteUID }, // Send the UID in the data
                dataType: 'json',

                success: function(response) {
                    showToast(response.message || `Employee ${employeeToDeleteName} successfully deleted!`, 'success');
                    employeeRow.fadeOut(300, function() {
                        $(this).remove(); // Remove row from DOM on successful deletion
                    });
                    toggleConfirmationModal(false);
                },
                error: function(xhr) {
                    let errorMessage = 'Failed to delete employee.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMessage = errorResponse.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Error (${xhr.status}): Could not reach server.`;
                    }
                    showToast(errorMessage, 'error');
                },
                complete: function() {
                    // Re-enable button and reset state
                    deleteButton.prop('disabled', false).text('Yes, Delete').removeClass('bg-gray-500 opacity-70').addClass('bg-red-600');
                }
            });
        }

        // --- Initialization and AJAX Setup ---

        $(document).ready(function() {

            // 6. Handle Clicks on Delete Buttons (Event Delegation)
            // Attaching to a static parent ('#employee-list-table') ensures this works even for dynamically added rows
            $('#employee-list-table').on('click', '.delete-btn', function() {
                const row = $(this).closest('tr');
                const uid = row.data('uid');
                const name = row.data('name');

                if (uid) {
                    employeeToDeleteUID = uid;
                    employeeToDeleteName = name;
                    $('#employee-name-to-delete').text(name); // Update modal text
                    toggleConfirmationModal(true);
                } else {
                    showToast("Error: Employee ID not found.", 'error');
                }
            });

        });
    </script>

    {% endblock script %}


